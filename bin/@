#!/bin/sh
NL=$'\n'
ON=~/.atom/dev/packages
OFF=~/.atom/dev/u

while getopts delsumwDELSUMW? o; do
	case $o in
		# Disable dev-linked packages
		D|d) {
			if [ -d $ON ]; then
				mv $ON $OFF
				echo "Disabled"
				exit 0
			fi
			echo "Already disabled"
		};;

		# Enable dev-linked packages
		E|e) {
			if [ ! -d $ON ]; then
				mv $OFF $ON
				echo "Enabled"
				exit 0
			fi
			echo "Already enabled"
		};;

		# List packages currently dev-linked
		L|l)
			[ -d $ON ] && dir=$ON || dir=$OFF;
			pkg=$(ls $dir)
			if [ ! "$pkg" ]; then
				"Empty directory: $pkg";
				exit 1;
			fi
			IFS=
			echo "Currently-linked:"
			echo $pkg | sed 's/^/  * /'
			exit 0
		;;

		# Open a manual page in Atom
		M|m) path=$(man -w "$2") && atom -d $(realpath "$path") || exit 1;;

		# Show status of devlinks
		S|s) [ ! -d $ON ] && echo "Disabled" || echo "Enabled" ;;

		# Force an update of installed packages
		U|u) apm update --no-confirm ;;

		# Wipe user-cache directories
		W|w) rm -rfv ~/.atom/{blob-store,compile-cache,recovery,storage} && echo "${NL}Nuked";;

		# Usage
		*|?)
			cat <<-"EOF"
			Usage: @ [-delsuw] [-m name]
			    -d  Disable devlinks
			    -e  Enable devlinks
			    -l  List devlinks
			    -s  Show enabled/disabled status
			    -u  Force apm update
			    -m  Open a named manpage in Atom
			    -w  Wipe user-cache directories
			EOF
		;;
	esac
done

# Open Atom in development mode.
if [ $OPTIND -eq 1 ]; then
	atom -d "${1:-.}"
fi
