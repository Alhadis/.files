#!/bin/sh
set +o posix;

[ $# -lt 1 ] && {
	>&2 echo "Usage: regroff [filename]"
	exit 1;
}

[ ! -f "$1" ] && {
	>&2 echo "Not a file: $1"
	exit 1;
}

filename=$(basename "$1" | sed -r 's/\.\w+$//')

# Close file if it's already open
osascript <<EOF
tell application "Preview"
	set windowCount to number of windows
	repeat with x from 1 to windowCount
		set docName to (name of document of front window)
		if (docName starts with "$filename") then
			close window x
		end if
	end repeat
end tell
EOF

# Generate PostScript file from Roff source
$(grog "$1") > "$filename.ps"

# Preview the result
open "$filename.ps"
